<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Wordlist Fetch & Parser</title>

    <style>
        body {
            font-family: system-ui, Segoe UI, Arial;
            max-width: 1200px;
            margin: 20px auto;
            padding: 16px;
        }

        input,
        textarea {
            width: 100%;
            font-family: monospace;
            font-size: 13px;
            padding: 8px;
            margin-bottom: 6px;
        }

        textarea {
            height: 220px;
        }

        button {
            padding: 8px 12px;
            margin: 4px 6px 4px 0;
            border-radius: 6px;
            border: 1px solid #bbb;
            cursor: pointer;
        }

        button.primary {
            background: #0366d6;
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 6px;
            vertical-align: top;
        }

        th {
            background: #f3f6fb;
        }

        .img-thumb {
            max-height: 70px;
            border-radius: 4px;
        }

        .small {
            font-size: 13px;
            color: #555;
        }

        .error {
            color: #b00;
        }
    </style>
</head>

<body>

    <h1>Wordlist Fetch & Auto Parse</h1>

    <input id="urlInput" placeholder="Dán link trang EssentialEnglish">
    <button id="btnFetch" class="primary">Fetch & Auto Parse</button>
    <span id="msg" class="small"></span>

    <textarea id="inputHtml" placeholder="HTML fetch được (debug)"></textarea>

    <div id="preview"></div>

    <script>
        (() => {

            const BASE = 'https://www.essentialenglish.review';

            const $ = id => document.getElementById(id);
            const urlInput = $('urlInput');
            const inputHtml = $('inputHtml');
            const preview = $('preview');
            const msg = $('msg');
            const btnFetch = $('btnFetch');

            let lastData = [];

            /* ===== Parse POS + Meaning (GIỮ <strong>) ===== */
            function parseDescription(div) {
                if (!div) return { pos: '', meaningHtml: '' };

                const em = div.querySelector('em');
                const pos = em ? em.textContent.trim() : '';

                const clone = div.cloneNode(true);
                clone.querySelectorAll('em').forEach(e => e.remove());

                return {
                    pos,
                    meaningHtml: clone.innerHTML.trim()
                };
            }

            function parseHtml(html) {
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const ul = doc.querySelector('ul.wordlist');
                if (!ul) return [];

                return [...ul.querySelectorAll('li')].map(li => {
                    const divs = li.querySelectorAll('div');
                    const imgAttr = li.getAttribute('img');

                    const { pos, meaningHtml } = parseDescription(divs[0]);

                    return {
                        word: li.getAttribute('word') || '',
                        pos,
                        meaningHtml,
                        exampleHtml: divs[1] ? divs[1].innerHTML.trim() : '',
                        image: imgAttr
                            ? `${BASE}/apps-data/4000-essential-english-words-2-2nd-edition/data/wordlist/${imgAttr}`
                            : ''
                    };
                });
            }

            function renderTable(data) {
                let html = `
    <table>
        <thead>
            <tr>
                <th>Word</th>
                <th>POS</th>
                <th>Meaning</th>
                <th>Example</th>
                <th>Image</th>
            </tr>
        </thead>
        <tbody>
    `;

                data.forEach(r => {
                    html += `
        <tr>
            <td><strong>${r.word}</strong></td>
            <td>${r.pos}</td>
            <td>${r.meaningHtml}</td>
            <td>${r.exampleHtml}</td>
            <td>${r.image ? `<img src="${r.image}" class="img-thumb">` : ''}</td>
        </tr>`;
                });

                html += '</tbody></table>';
                preview.innerHTML = html;
            }

            /* ===== AUTO COPY TSV (GIỮ <strong>) ===== */
            async function autoCopyTSV(data) {
                const rows = data.map(r =>
                    [
                        r.word,
                        r.pos,
                        r.meaningHtml.replace(/\t|\n/g, ' '),
                        r.exampleHtml.replace(/\t|\n/g, ' '),
                        r.image
                    ].join('\t')
                );

                await navigator.clipboard.writeText(rows.join('\n'));
            }

            /* ===== FETCH → PARSE → RENDER → AUTO COPY ===== */
            btnFetch.onclick = async () => {
                const url = urlInput.value.trim();
                if (!url) return alert('Chưa nhập link');

                msg.textContent = 'Đang fetch...';
                msg.className = 'small';

                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(res.status);

                    const html = await res.text();
                    inputHtml.value = html;

                    lastData = parseHtml(html);
                    if (!lastData.length) {
                        msg.textContent = 'Không tìm thấy wordlist';
                        msg.className = 'small error';
                        return;
                    }

                    renderTable(lastData);
                    await autoCopyTSV(lastData);

                    msg.textContent = `Parsed ${lastData.length} words → TSV đã copy (giữ in đậm)`;

                } catch (e) {
                    console.error(e);
                    msg.textContent = 'Fetch thất bại (CORS / link lỗi)';
                    msg.className = 'small error';
                }
            };

        })();
    </script>

</body>

</html>