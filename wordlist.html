<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>HTML → Wordlist Table Parser</title>

    <style>
        body {
            font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial;
            max-width: 1100px;
            margin: 20px auto;
            padding: 16px;
        }

        textarea {
            width: 100%;
            height: 280px;
            font-family: monospace;
            font-size: 13px;
            padding: 10px;
        }

        button {
            padding: 8px 12px;
            margin: 4px 4px 4px 0;
            border-radius: 6px;
            border: 1px solid #bbb;
            cursor: pointer;
        }

        button.primary {
            background: #0366d6;
            color: #fff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 6px;
            vertical-align: top;
        }

        th {
            background: #f3f6fb;
        }

        .img-thumb {
            max-height: 70px;
            border-radius: 4px;
        }

        .small {
            font-size: 13px;
            color: #555;
        }

        .error {
            color: #b00;
        }

        .col-toggle label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #eee;
            padding: 4px 6px;
            border-radius: 6px;
            margin: 3px;
        }
    </style>
</head>

<body>

    <h1>HTML → Wordlist Table</h1>
    <p class="small">Dán <code>&lt;ul class="wordlist"&gt;</code> rồi parse.</p>

    <textarea id="inputHtml" placeholder="Dán HTML ở đây..."></textarea>

    <div>
        <button id="btnParse" class="primary">Parse</button>
        <button id="btnCopyTSV">Copy TSV (Excel)</button>
        <button id="btnCopyCSV">Copy CSV</button>
        <button id="btnDownloadCSV">Export CSV</button>
        <button id="btnDownloadJSON">Export JSON</button>
        <button id="btnDownloadHTML">Export HTML</button>
        <button id="btnClear">Clear</button>
        <span id="msg" class="small"></span>
    </div>

    <h3 class="small">Chọn cột hiển thị</h3>
    <div id="colToggle" class="col-toggle"></div>

    <div id="preview"></div>

    <script>
        (function () {

            const defaultCols = [
                { key: 'word', label: 'Word' },
                { key: 'desc', label: 'Description' },
                { key: 'example', label: 'Example' },
                { key: 'imgSrc', label: 'Image' },
                { key: 'source', label: 'Audio' }
            ];

            const $ = id => document.getElementById(id);
            const input = $('inputHtml'), preview = $('preview'), msg = $('msg');
            const btnParse = $('btnParse'), btnClear = $('btnClear');
            const btnCopyCSV = $('btnCopyCSV'), btnCopyTSV = $('btnCopyTSV');
            const btnDownloadCSV = $('btnDownloadCSV'), btnDownloadJSON = $('btnDownloadJSON');
            const btnDownloadHTML = $('btnDownloadHTML'), colToggle = $('colToggle');

            let lastData = [];

            /* ===== GIỮ LẠI CHỈ <strong> ===== */
            function keepOnlyStrong(html) {
                const wrapper = document.createElement('div');
                wrapper.innerHTML = html;

                const walker = document.createTreeWalker(
                    wrapper,
                    NodeFilter.SHOW_ELEMENT,
                    null
                );

                const toUnwrap = [];

                while (walker.nextNode()) {
                    const el = walker.currentNode;
                    if (el.tagName !== 'STRONG') {
                        toUnwrap.push(el);
                    }
                }

                toUnwrap.forEach(el => {
                    el.replaceWith(...el.childNodes);
                });

                return wrapper.innerHTML.trim();
            }

            function createColToggles() {
                colToggle.innerHTML = '';
                defaultCols.forEach(c => {
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.checked = true;
                    cb.dataset.key = c.key;

                    const label = document.createElement('label');
                    label.appendChild(cb);
                    label.append(c.label);
                    colToggle.appendChild(label);
                });
            }

            function parseHtml(html) {
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const ul = doc.querySelector('ul.wordlist') || doc.querySelector('ul');
                if (!ul) return [];

                return Array.from(ul.querySelectorAll('li')).map(li => {
                    const img = li.querySelector('img');
                    const descEl = li.querySelector('.en-desc');
                    const examEl = li.querySelector('.en-exam');

                    return {
                        word: li.getAttribute('word') || li.querySelector('.en-word')?.textContent.trim() || '',
                        imgSrc: img ? 'https://www.essentialenglish.review/' + img.getAttribute('src') : '',
                        source: li.getAttribute('source')
                            ? 'https://www.essentialenglish.review/' + li.getAttribute('source')
                            : '',
                        desc: descEl ? keepOnlyStrong(descEl.innerHTML).replace(' </strong>', '</strong> ') : '',
                        example: examEl
                            ? keepOnlyStrong(
                                examEl.innerHTML.replace(/^<span[^>]*>→<\/span>\s*/, '')
                            ).replace(' </strong>', '</strong> ')
                            : ''
                    };
                });
            }

            function getKeys() {
                return Array.from(colToggle.querySelectorAll('input:checked'))
                    .map(cb => cb.dataset.key);
            }

            function renderTable(data) {
                const keys = getKeys();
                let html = '<table><thead><tr>';

                keys.forEach(k => {
                    html += `<th>${defaultCols.find(c => c.key === k).label}</th>`;
                });

                html += '</tr></thead><tbody>';

                data.forEach(row => {
                    html += '<tr>';
                    keys.forEach(k => {
                        if (k === 'imgSrc' && row[k]) {
                            html += `<td><img src="${row[k]}" class="img-thumb"></td>`;
                        } else if (k === 'source' && row[k]) {
                            html += `<td><a href="${row[k]}" target="_blank">${row[k]}</a></td>`;
                        } else {
                            html += `<td>${row[k] || ''}</td>`;
                        }
                    });
                    html += '</tr>';
                });

                html += '</tbody></table>';
                preview.innerHTML = html;
            }

            function toDelimited(data, keys, sep) {
                return [
                    keys.join(sep),
                    ...data.map(r =>
                        keys.map(k =>
                            String(r[k] || '').replace(/\r?\n|\t/g, ' ')
                        ).join(sep)
                    )
                ].join('\n');
            }

            function downloadFile(content, type, ext) {
                const blob = new Blob([content], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `wordlist-${Date.now()}.${ext}`;
                a.click();
                URL.revokeObjectURL(url);
            }

            /* EVENTS */

            btnParse.onclick = () => {
                lastData = parseHtml(input.value);
                if (!lastData.length) {
                    msg.textContent = 'Không tìm thấy dữ liệu.';
                    msg.className = 'small error';
                    return;
                }
                renderTable(lastData);
                msg.textContent = `Parsed ${lastData.length} items`;
                msg.className = 'small';
            };

            btnClear.onclick = () => {
                input.value = '';
                preview.innerHTML = '';
                msg.textContent = '';
            };

            btnCopyCSV.onclick = async () => {
                await navigator.clipboard.writeText(
                    toDelimited(lastData, getKeys(), ',')
                );
                msg.textContent = 'Đã copy CSV';
            };

            btnCopyTSV.onclick = async () => {
                await navigator.clipboard.writeText(
                    toDelimited(lastData, getKeys(), '\t')
                );
                msg.textContent = 'Đã copy TSV (Excel)';
            };

            btnDownloadCSV.onclick = () =>
                downloadFile(toDelimited(lastData, getKeys(), ','), 'text/csv', 'csv');

            btnDownloadJSON.onclick = () =>
                downloadFile(JSON.stringify(lastData, null, 2), 'application/json', 'json');

            btnDownloadHTML.onclick = () =>
                downloadFile(
                    `<!doctype html><html><head><meta charset="utf-8"><title>Wordlist</title></head><body>${preview.innerHTML}</body></html>`,
                    'text/html',
                    'html'
                );

            createColToggles();

        })();
    </script>

</body>

</html>
